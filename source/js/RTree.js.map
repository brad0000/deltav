{"version":3,"sources":["RTree.ts"],"names":[],"mappings":"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","file":"RTree.js","sourcesContent":["namespace deltav {\r\n\r\n    export class RTree {\r\n\r\n        private root: RTreeNode;\r\n        private nodesByBodyTag: { [i: number]: Array<RTreeNode> };\r\n\r\n        constructor(world: World) {\r\n            \r\n            let iBoxes: Box[], jBoxes: Box[], kBoxes: Box[], lBoxes: Box[], mBoxes: Box[];\r\n            let iNode: RTreeNode, jNode: RTreeNode, kNode: RTreeNode, lNode: RTreeNode, mNode: RTreeNode;\r\n            \r\n            this.root = new RTreeNode(world, false, false);\r\n            this.nodesByBodyTag = { };\r\n\r\n            iBoxes = world.divide();\r\n            for (let i = 0; i < iBoxes.length; i++) {\r\n                iNode = new RTreeNode(iBoxes[i], false, false);\r\n                \r\n                jBoxes = iBoxes[i].divide();\r\n                for (let j = 0; j < 4; j++) {\r\n                    jNode = new RTreeNode(jBoxes[j], false, false);\r\n\r\n                    kBoxes = jBoxes[j].divide();\r\n                    for (let k = 0; k < 4; k++) {\r\n                        kNode = new RTreeNode(kBoxes[k], false, false);\r\n                        \r\n                        lBoxes = kBoxes[k].divide();\r\n                        for (let l = 0; l < 4; l++) {\r\n                            lNode = new RTreeNode(lBoxes[l], false, false);\r\n\r\n                            mBoxes = lBoxes[l].divide();\r\n                            for (let m = 0; m < 4; m++) {\r\n                                mNode = new RTreeNode(mBoxes[m], true, false);\r\n                                lNode.children.push(mNode);\r\n                            }                        \r\n                            \r\n                            kNode.children.push(lNode);\r\n                        }\r\n                        \r\n                        jNode.children.push(kNode);    \r\n                    }                \r\n                    \r\n                    iNode.children.push(jNode);\r\n                }\r\n                \r\n                this.root.children.push(iNode);        \r\n            }\r\n        }\r\n\r\n        public add(body: Body): RTreeNode {\r\n            this.nodesByBodyTag[body.tag] = [];\r\n            return this.root.add(body, this.nodesByBodyTag[body.tag]);\r\n        }\r\n        \r\n        public remove(body: Body) {\r\n            let nodes = this.nodesByBodyTag[body.tag];\r\n            \r\n            for (let i = 0; i < nodes.length; i++) {\r\n                nodes[i].remove();\r\n            }\r\n        }\r\n        \r\n        public search(box: Box): Body[] {\r\n            let hits = new Array<Body>();\r\n            this.root.search(box, hits);\r\n            return hits;\r\n        }\r\n    }\r\n\r\n    export class RTreeNode {\r\n        public children = new Array<RTreeNode>();\r\n        public body: Body;\r\n        private parent: RTreeNode;\r\n        \r\n        constructor(\r\n            public box: Box,\r\n            public isLastBranch, \r\n            public isLeaf: boolean) {\r\n            // nothing\r\n        }\r\n        \r\n        public search(searchArea: Box, hits: Array<Body>) {\r\n            if (this.isLeaf) {\r\n                if (searchArea.intersects(this.body.getBoundingBox())) {\r\n                    hits.push(this.body);\r\n                }\r\n            } else {\r\n                // Searching a branch            \r\n                if (this.box.intersects(searchArea)) {\r\n                    for (let i = 0; i < this.children.length; i++) {\r\n                        this.children[i].search(searchArea, hits);\r\n                    }\r\n                } else {\r\n                    return;\r\n                }\r\n            }   \r\n        }\r\n        \r\n        public add(body: Body, resultingNodes: Array<RTreeNode>) {\r\n            if (this.isLeaf) {\r\n                // this node IS a star, don't add stars to stars.\r\n                return null;\r\n            } else if (this.isLastBranch) {\r\n                // this is the ONLY level that we add stars.\r\n                if (this.box.intersects(body.getBoundingBox())) {\r\n                    let result = new RTreeNode(body.getBoundingBox(), false, true);\r\n                    result.body = body;\r\n                    result.addToParent(this);\r\n                    \r\n                    resultingNodes.push(result);\r\n                }\r\n            } else {\r\n                // this is an internal branch, just check to see if it's worth notifying children.\r\n                if (this.box.intersects(body.getBoundingBox())) {\r\n                    for (let i = 0; i < this.children.length; i++) {\r\n                        this.children[i].add(body, resultingNodes);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        \r\n        public addToParent(parent: RTreeNode) {\r\n            this.parent = parent;\r\n            parent.children.push(this);\r\n        }\r\n\r\n        public remove() {\r\n            this.parent.removeChild(this);\r\n        }\r\n        \r\n        public removeChild(child: RTreeNode) {\r\n            this.children.splice(this.children.indexOf(child), 1);\r\n        }\r\n    }\r\n}\r\n"],"sourceRoot":"/source/"}